# variables:
#   TARGET: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
#   CONTEXT: '.'
#   DOCKERFILE: 'Dockerfile'

.buildah_bud: &buildah_bud
  image:
    name: quay.io/buildah/stable
  variables:
    BUILDAH_ISOLATION: chroot
    STORAGE_DRIVER: vfs
    FORMAT: oci
    TLSVERIFY: 'true'
    CONTEXT: '.'
    DOCKERFILE: 'Dockerfile'
    TARGET: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    CREDENTIALS: ''
    OPTIONS: ''
  before_script:
    - whoami
    - echo $HOME
    - echo $XDG_RUNTIME_DIR
    - ls -lha /home
    - cat /etc/subuid
    - cat /etc/subgid
  script:
    - buildah --storage-driver=$STORAGE_DRIVER bud --format=$FORMAT --tls-verify=$TLSVERIFY --no-cache -t $TARGET -f $DOCKERFILE $CONTEXT
  # after_script:
    # - skopeo --version
    # - podman version
